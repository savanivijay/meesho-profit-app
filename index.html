<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meesho Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f4f4f4;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    input[type="file"] {
      display: block;
      margin: 20px auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    .summary {
      background: #fff;
      padding: 20px;
      margin-top: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .summary h3 {
      margin-top: 0;
    }
  </style>
</head>
<body>
  <h1>📊 Meesho Payment Sheet Analytics</h1>
  <input type="file" id="excelFile" accept=".xlsx, .xls" />
  <div id="output"></div>

  <script>
    document.getElementById("excelFile").addEventListener("change", handleFile, false);

    function handleFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const sheetName = "Order Payments";
            const sheet = workbook.Sheets[sheetName];

            if (!sheet) {
                document.getElementById("output").innerHTML = "❌ 'Order Payments' sheet not found.";
                return;
            }

            const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

            if (json.length === 0) {
                document.getElementById("output").innerHTML = "❌ No data found. Please upload a valid Meesho Excel file.";
                return;
            }

            const grouped = {};
            let totalPayout = 0;
            let returnCount = 0;

            json.forEach(row => {
                const sku = row["Supplier SKU"];
                const qty = parseInt(row["Quantity"]) || 0;
                const status = (row["Live Order Status"] || "").toLowerCase();
                const payout = parseFloat(row["Total Payout"]) || 0;

                if (!sku) return;

                if (!grouped[sku]) {
                    grouped[sku] = { quantity: 0, returns: 0 };
                }

                grouped[sku].quantity += qty;
                if (status.includes("return") || status.includes("rto")) {
                    grouped[sku].returns += 1;
                    returnCount += 1;
                }

                totalPayout += payout;
            });

            let table = `<table><tr>
                <th>Supplier SKU</th>
                <th>Quantity Sold</th>
                <th>Returns</th>
                <th>Return Ratio (%)</th>
            </tr>`;

            for (let sku in grouped) {
                const qty = grouped[sku].quantity;
                const ret = grouped[sku].returns;
                const ratio = qty === 0 ? 0 : ((ret / qty) * 100).toFixed(2);
                table += `<tr>
                    <td>${sku}</td>
                    <td>${qty}</td>
                    <td>${ret}</td>
                    <td>${ratio}%</td>
                </tr>`;
            }

            table += `</table>`;

            const summary = `
                <div class="summary">
                    <h3>📈 Summary</h3>
                    <p><strong>Total Payout:</strong> ₹${totalPayout.toFixed(2)}</p>
                    <p><strong>Total Returns:</strong> ${returnCount}</p>
                </div>
            `;

            document.getElementById("output").innerHTML = summary + table;
        };

        reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
