<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meesho Seller Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .counter {
      font-variant-numeric: tabular-nums;
    }
    .scroll-table {
      max-height: 400px;
      overflow-y: auto;
    }
    .custom-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold text-center mb-8">ðŸ“Š Meesho Seller Dashboard</h1>

    <!-- File Upload -->
    <div class="custom-card p-6 mb-6">
      <label class="block text-lg font-semibold mb-2">Upload Meesho Excel File</label>
      <input id="fileUpload" type="file" accept=".xlsx" class="border p-2 rounded w-full" />
      <p class="text-sm mt-2 text-gray-500">Only Meesho Payment Sheet supported.</p>
    </div>

    <!-- Summary Cards -->
    <div id="summaryCards" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6"></div>

    <!-- Order Details -->
    <div class="custom-card p-4 mb-6">
      <h2 class="text-xl font-bold mb-2">ðŸ“¦ Order Details</h2>
      <div id="orderDetails" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </div>

    <!-- SKU-Wise Profit Details -->
    <div class="custom-card p-4 mb-6">
      <h2 class="text-xl font-bold mb-2">ðŸ§¾ SKU Wise Profit Details</h2>
      <div class="scroll-table">
        <table class="min-w-full table-auto border border-gray-300">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-2 border">SKU</th>
              <th class="px-2 py-2 border">Sold/Return/RTO</th>
              <th class="px-2 py-2 border">Settlement</th>
              <th class="px-2 py-2 border">Return Loss</th>
              <th class="px-2 py-2 border">Cost Price (â‚¹)</th>
              <th class="px-2 py-2 border">Profit/Loss</th>
            </tr>
          </thead>
          <tbody id="skuProfitTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Chart Section -->
    <div class="custom-card p-4 mb-6">
      <h2 class="text-xl font-bold mb-2">ðŸ“ˆ Profit Distribution</h2>
      <canvas id="profitChart"></canvas>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>
  <script>
    const fileUpload = document.getElementById('fileUpload');

    fileUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (evt) => {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes("order") || name.toLowerCase().includes("payment"));
        const sheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet);
        processData(json);
      };
      reader.readAsArrayBuffer(file);
    });

    function processData(rows) {
      const summary = {
        totalSettlement: 0,
        adCost: 0,
        productCost: 0,
        otherCost: 0,
        profit: 0,
      };

      const orderStats = {
        total: 0,
        delivered: 0,
        return: 0,
        rto: 0,
      };

      const skuData = {};

      rows.forEach(row => {
        const sku = row['Supplier SKU'] || row['supplier sku'];
        const qty = parseInt(row['Quantity'] || 0);
        const status = (row['Live Order Status'] || '').toLowerCase();
        const payout = parseFloat(row['Total Payout'] || 0);

        if (!sku) return;
        if (!skuData[sku]) {
          skuData[sku] = { sold: 0, return: 0, rto: 0, payout: 0, returnLoss: 0 };
        }

        if (status.includes("delivered")) {
          skuData[sku].sold += qty;
          orderStats.delivered += qty;
        } else if (status.includes("return")) {
          skuData[sku].return += qty;
          skuData[sku].returnLoss += payout;
          orderStats.return += qty;
        } else if (status.includes("rto")) {
          skuData[sku].rto += qty;
          orderStats.rto += qty;
        }

        skuData[sku].payout += payout;
        summary.totalSettlement += payout;
        orderStats.total += qty;
      });

      // Update Summary Cards
      summaryCards.innerHTML = '';
      const summaryData = [
        ['Total Settlement', summary.totalSettlement],
        ['Ad Cost', summary.adCost],
        ['Product Cost', summary.productCost],
        ['Other Cost', summary.otherCost],
        ['Profit', summary.totalSettlement - summary.adCost - summary.productCost - summary.otherCost],
      ];

      summaryData.forEach(([label, value]) => {
        summaryCards.innerHTML += `
          <div class="bg-white rounded-xl shadow p-4 text-center">
            <div class="text-sm text-gray-600">${label}</div>
            <div class="text-xl font-bold counter text-blue-600">â‚¹${value.toFixed(2)}</div>
          </div>`;
      });

      // Update Order Details
      orderDetails.innerHTML = '';
      [['Total Orders', orderStats.total], ['Delivered', orderStats.delivered], ['Return', orderStats.return], ['RTO', orderStats.rto]].forEach(([label, val]) => {
        orderDetails.innerHTML += `<div class="bg-gray-50 rounded p-3 text-center"><div class="text-sm">${label}</div><div class="text-lg font-semibold">${val}</div></div>`;
      });

      // SKU Profit Table
      const tbody = document.getElementById('skuProfitTable');
      tbody.innerHTML = '';

      Object.keys(skuData).forEach(sku => {
        const data = skuData[sku];
        const costPrice = 100; // You can replace this later with editable field input
        const totalCost = costPrice * data.sold;
        const profit = data.payout - totalCost - data.returnLoss;

        tbody.innerHTML += `
          <tr>
            <td class="border px-2 py-1">${sku}</td>
            <td class="border px-2 py-1">${data.sold}/${data.return}/${data.rto}</td>
            <td class="border px-2 py-1">â‚¹${data.payout.toFixed(2)}</td>
            <td class="border px-2 py-1">â‚¹${data.returnLoss.toFixed(2)}</td>
            <td class="border px-2 py-1">â‚¹${costPrice.toFixed(2)}</td>
            <td class="border px-2 py-1 font-bold ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">â‚¹${profit.toFixed(2)}</td>
          </tr>`;
      });

      // Chart
      const ctx = document.getElementById('profitChart').getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Settlement', 'Ad Cost', 'Product Cost', 'Other Cost', 'Profit'],
          datasets: [{
            data: [
              summary.totalSettlement,
              summary.adCost,
              summary.productCost,
              summary.otherCost,
              summary.totalSettlement - summary.adCost - summary.productCost - summary.otherCost
            ],
            backgroundColor: ['#4ade80', '#facc15', '#60a5fa', '#f87171', '#a78bfa']
          }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }
  </script>
</body>

</html>
