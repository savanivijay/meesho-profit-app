<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meesho Seller Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: #f4f6fa;
      font-family: 'Segoe UI', sans-serif;
    }
    .card {
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.05);
    }
    .counter-box {
      text-align: center;
      padding: 20px;
    }
    .counter-number {
      font-size: 28px;
      font-weight: bold;
    }
    .highlight {
      color: #0d6efd;
    }
    .upload-area {
      border: 2px dashed #0d6efd;
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      background: #eaf1ff;
      cursor: pointer;
    }
    .upload-area:hover {
      background: #d6e6ff;
    }
    .sku-table th {
      background-color: #0d6efd;
      color: white;
    }
    .chart-container {
      width: 100%;
      height: 300px;
    }
  </style>
</head>
<body>
  <div class="container my-5">
    <h2 class="text-center mb-4 text-primary">üìä Meesho Seller Profit Dashboard</h2>

    <!-- Upload -->
    <div class="upload-area mb-4" onclick="document.getElementById('excelFile').click()">
      <h5>üìÅ Click to upload Meesho Excel file</h5>
      <input type="file" id="excelFile" accept=".xlsx" hidden />
    </div>

    <!-- Counters -->
    <div class="row text-white">
      <div class="col-md-3 mb-3">
        <div class="card bg-primary counter-box">
          <div>Total Settlement</div>
          <div class="counter-number" id="settlement">‚Çπ0</div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card bg-success counter-box">
          <div>Total Profit</div>
          <div class="counter-number" id="profit">‚Çπ0</div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card bg-danger counter-box">
          <div>Total Ad Cost</div>
          <div class="counter-number" id="adCost">‚Çπ0</div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card bg-warning counter-box">
          <div>Other Costs</div>
          <div class="counter-number" id="otherCost">‚Çπ0</div>
        </div>
      </div>
    </div>

    <!-- Order Details -->
    <div class="row mt-4">
      <div class="col-md-3 mb-3">
        <div class="card counter-box">
          <div>Total Orders</div>
          <div class="counter-number" id="totalOrders">0</div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card counter-box">
          <div>Delivered</div>
          <div class="counter-number" id="delivered">0</div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card counter-box">
          <div>Returns</div>
          <div class="counter-number" id="returns">0</div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card counter-box">
          <div>Return Ratio</div>
          <div class="counter-number" id="returnRatio">0%</div>
        </div>
      </div>
    </div>

    <!-- Chart -->
    <div class="card my-4 p-4">
      <h5>üìà Profit Analysis Chart</h5>
      <div class="chart-container">
        <canvas id="profitChart"></canvas>
      </div>
    </div>

    <!-- SKU Table -->
    <div class="card p-4 mb-5">
      <h5>üì¶ SKU-Wise Profit Details</h5>
      <div class="table-responsive">
        <table class="table sku-table">
          <thead>
            <tr>
              <th>SKU</th>
              <th>Sold/Return/RTO</th>
              <th>Settlement</th>
              <th>Return Loss</th>
              <th>Cost Price</th>
              <th>Profit/Loss</th>
            </tr>
          </thead>
          <tbody id="skuTableBody">
            <tr><td colspan="6" class="text-center">No data available</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    const fileInput = document.getElementById('excelFile');
    fileInput.addEventListener('change', handleFile);

    function handleFile(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(sheet);

        if (jsonData.length === 0) return alert('‚ùå No data found. Please upload a valid Meesho Excel file.');

        document.getElementById("settlement").textContent = "‚Çπ" + getSum(jsonData, "Total Settlement");
        document.getElementById("adCost").textContent = "‚Çπ" + getSum(jsonData, "Total Ad Cost");
        document.getElementById("otherCost").textContent = "‚Çπ" + getSum(jsonData, "Other cost");
        document.getElementById("profit").textContent = "‚Çπ" + getSum(jsonData, "Profit");

        document.getElementById("totalOrders").textContent = jsonData.length;
        document.getElementById("delivered").textContent = countByStatus(jsonData, "Delivered");
        const returns = countByStatus(jsonData, "Return");
        document.getElementById("returns").textContent = returns;
        document.getElementById("returnRatio").textContent = ((returns / jsonData.length) * 100).toFixed(1) + "%";

        populateTable(jsonData);
        drawChart(jsonData);
      };
      reader.readAsArrayBuffer(file);
    }

    function getSum(data, field) {
      return data.reduce((sum, row) => sum + (parseFloat(row[field]) || 0), 0).toFixed(2);
    }

    function countByStatus(data, status) {
      return data.filter(row => (row["Live Order Status"] || '').toLowerCase() === status.toLowerCase()).length;
    }

    function populateTable(data) {
      const table = document.getElementById("skuTableBody");
      table.innerHTML = "";
      const grouped = {};

      data.forEach(row => {
        const sku = row["Supplier SKU"] || "-";
        if (!grouped[sku]) grouped[sku] = { sold: 0, return: 0, rto: 0, settlement: 0, returnLoss: 0, cost: 0, profit: 0 };

        const status = (row["Live Order Status"] || '').toLowerCase();
        if (status === "delivered") grouped[sku].sold++;
        if (status === "return") grouped[sku].return++;
        if (status === "rto") grouped[sku].rto++;

        grouped[sku].settlement += parseFloat(row["Total Settlement"] || 0);
        grouped[sku].returnLoss += parseFloat(row["Return Loss"] || 0);
        grouped[sku].cost += parseFloat(row["Product cost"] || 0);
        grouped[sku].profit += parseFloat(row["Profit"] || 0);
      });

      Object.keys(grouped).forEach(sku => {
        const d = grouped[sku];
        const row = `<tr>
          <td>${sku}</td>
          <td>${d.sold}/${d.return}/${d.rto}</td>
          <td>‚Çπ${d.settlement.toFixed(2)}</td>
          <td>‚Çπ${d.returnLoss.toFixed(2)}</td>
          <td>‚Çπ${d.cost.toFixed(2)}</td>
          <td>‚Çπ${d.profit.toFixed(2)}</td>
        </tr>`;
        table.innerHTML += row;
      });
    }

    function drawChart(data) {
      const ctx = document.getElementById("profitChart").getContext("2d");
      const labels = [...new Set(data.map(row => row["Supplier SKU"]))];
      const profits = labels.map(label => {
        return data
          .filter(row => row["Supplier SKU"] === label)
          .reduce((sum, row) => sum + (parseFloat(row["Profit"] || 0)), 0);
      });
      new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Profit by SKU",
            backgroundColor: "#0d6efd",
            data: profits
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          }
        }
      });
    }
  </script>
</body>
</html>
