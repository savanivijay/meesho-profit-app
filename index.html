<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meesho Seller Analyzer</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: #f2f4f8;
    }
    header {
      background: #673ab7;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .container {
      max-width: 960px;
      margin: auto;
      padding: 20px;
    }
    .upload-box {
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
    }
    input[type="file"] {
      padding: 10px;
    }
    .summary-box {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    .summary-item {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #e1e1e1;
    }
  </style>
</head>
<body>

  <header>
    <h1>üìä Meesho Seller Analyzer</h1>
    <p>Upload your payment sheet to see profit & return breakdown</p>
  </header>

  <div class="container">
    <div class="upload-box">
      <input type="file" id="fileUpload" accept=".xlsx"/>
    </div>

    <div class="summary-box" id="summary"></div>

    <div id="output"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    document.getElementById("fileUpload").addEventListener("change", handleFile, false);

    function handleFile(event) {
      const file = event.target.files[0];
      const reader = new FileReader();

      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        const sheet = workbook.Sheets["Order Payments"];
        if (!sheet) {
          alert("‚ùå 'Order Payments' sheet not found!");
          return;
        }

        const json = XLSX.utils.sheet_to_json(sheet);
        if (!json.length) {
          alert("‚ùå No data found in sheet.");
          return;
        }

        const summary = {
          totalOrders: 0,
          totalRevenue: 0,
          totalProfit: 0,
          totalReturns: 0
        };

        const skuMap = {};

        json.forEach(row => {
          const sku = row["Product Id/SKU"] || "Unknown";
          const name = row["Product Title"] || "No Title";
          const price = parseFloat(row["Selling Price"]) || 0;
          const charges = parseFloat(row["Meesho Charges"]) || 0;
          const status = (row["Order Status"] || "").toLowerCase();

          if (!skuMap[sku]) {
            skuMap[sku] = { sku, name, orders: 0, revenue: 0, charges: 0, returns: 0 };
          }

          if (status.includes("delivered")) {
            skuMap[sku].orders++;
            skuMap[sku].revenue += price;
            skuMap[sku].charges += charges;
          } else if (status.includes("returned") || status.includes("cancelled")) {
            skuMap[sku].returns++;
          }
        });

        // Prepare output
        let tableHTML = `
          <table>
            <thead>
              <tr>
                <th>SKU</th>
                <th>Product Name</th>
                <th>Orders</th>
                <th>Revenue</th>
                <th>Charges</th>
                <th>Returns</th>
                <th>Profit</th>
                <th>Return %</th>
              </tr>
            </thead>
            <tbody>
        `;

        Object.values(skuMap).forEach(item => {
          const profit = item.revenue - item.charges;
          const returnRate = item.returns / (item.orders + item.returns || 1) * 100;

          summary.totalOrders += item.orders;
          summary.totalRevenue += item.revenue;
          summary.totalProfit += profit;
          summary.totalReturns += item.returns;

          tableHTML += `
            <tr>
              <td>${item.sku}</td>
              <td>${item.name}</td>
              <td>${item.orders}</td>
              <td>‚Çπ${item.revenue.toFixed(2)}</td>
              <td>‚Çπ${item.charges.toFixed(2)}</td>
              <td>${item.returns}</td>
              <td>‚Çπ${profit.toFixed(2)}</td>
              <td>${returnRate.toFixed(1)}%</td>
            </tr>
          `;
        });

        tableHTML += "</tbody></table>";

        // Show summary
        const summaryHTML = `
          <div class="summary-item"><h3>üßæ Total Orders</h3><p>${summary.totalOrders}</p></div>
          <div class="summary-item"><h3>üí∞ Revenue</h3><p>‚Çπ${summary.totalRevenue.toFixed(2)}</p></div>
          <div class="summary-item"><h3>üìà Profit</h3><p>‚Çπ${summary.totalProfit.toFixed(2)}</p></div>
          <div class="summary-item"><h3>üì¶ Returns</h3><p>${summary.totalReturns}</p></div>
          <div class="summary-item"><h3>üîÅ Return %</h3><p>${(summary.totalReturns / (summary.totalOrders + summary.totalReturns) * 100).toFixed(1)}%</p></div>
        `;

        document.getElementById("summary").innerHTML = summaryHTML;
        document.getElementById("output").innerHTML = tableHTML;
      };

      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
